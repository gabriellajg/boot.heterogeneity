---
title: "A Monte Carlo Based Test for Between-study Heterogeneity in Meta-Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mc.heterogeneity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

###### 

This R package mc.heterogeneity provides functions for testing between-study heterogeneity in meta-analysis of standardized mean differences (d), Fisher-transformed Pearson's correlations (r), and natural-logarithm-transformed odds ratio (OR). 

Inclusion of moderators is an option for researchers who are interested in measuring the between-study heterogeneity per se and exploring factors that can explain the systematic between-study heterogeneity. 

In the following examples, we describe how to use our package mc.heterogeneity to test the between-study heterogeneity for each of the effect sizes considered in the current study. *Datasets*, *R codes*, and *output* are provided for each example so that applied researchers can easily replicate the examples and modify the codes for their own datasets. 

* The three example datasets are internal datasets in our package, but applied researchers can load the datasets using mc.heterogeneity:::[dataset name]. In each of the example datasets, the rows correspond to studies in meta-analysis, and the columns correspond to required input for that study, which includes, but is not limited to effect size, sample size(s), and moderators. 

* The example R codes adopt the default value for some of the arguments (e.g., default cutoff p-vakue 0.05). To change the defaults, use help() to see more details for each of the functions. 

* The output are formatted to have the same layout. 

We also include a "Empirical Illustration" section in the article to discuss the following examples. 

## 0. Installation of the package

Install the released version of mc.heterogeneity from [CRAN](https://CRAN.R-project.org) with:

```{r setup, eval=FALSE}
install.packages("mc.heterogeneity")
```

Or install the development version from [GitHub](https://github.com/gabriellajg/mc.heterogeneity) with:

```{r, eval=FALSE}
#install.packages("devtools")
library(devtools)
devtools::install_github("gabriellajg/mc.heterogeneity", force = TRUE, build_vignettes = TRUE)
library(mc.heterogeneity)
```

```{r, echo=FALSE}
library("mc.heterogeneity")
```

### 1. Standardized Mean Differences (d)

`mc.d()` is the function to test the between-study heterogeneity in meta-analysis of standardized mean differences (d). 

### 1.1 Without moderators

Load the example dataset `selfconcept` first: 

```{r}
selfconcept <- mc.heterogeneity:::selfconcept
```

Extract the required arguments from `selfconcept`:
```{r}
# n1 and n2 are lists of samples sizes in two groups
n1 <- selfconcept$n1
n2 <- selfconcept$n2
# g is a list of effect sizes
g <- selfconcept$g
```

If `g` is a list of biased estimates of standardized mean differences in the meta-analytical study, a small-sample adjustment must be applied:

```{r}
cm <- (1-3/(4*(n1+n2-2)-1)) #correct factor to compensate for small sample bias (Hedges, 1981)
d <- cm*g
```

Run the heterogeneity test using `mc.d()`:

```{r, eval=FALSE}
mc.run <- mc.d(n1, n2, est = d, model = 'random', p_cut = 0.05)
```

Alternatively, such an adjustment could be performed within the function by specifying `adjust = TRUE`:

```{r, eval=FALSE}
mc.run2 <- mc.d(n1, n2, est = g, model = 'random', adjust = TRUE, p_cut = 0.05)
```

### 1.1 With moderators

Load an hypothetical dataset `hypo_moder` first: 

```{r}
hypo_moder <- mc.heterogeneity:::hypo_moder
```

Three moderators (cov.z1, cov.z2, cov.z3) are included: 

```{r}
head(hypo_moder)
```

Again, run the heterogeneity test using `mc.d()` with all moderators included in a matrix `mods` and model type specified as `model = 'mixed'`:

```{r, eval=FALSE}
mc.run3 <- mc.d(n1 = hypo_moder$n1, 
                n2 = hypo_moder$n2, 
                est = hypo_moder$d, 
                model = 'mixed', 
                mods = cbind(hypo_moder$cov.z1, hypo_moder$cov.z2, hypo_moder$cov.z1), 
                p_cut = 0.05)
```

#### For the following two examples (Fisher-transformed Pearson's correlations r; Natural-logarithm-transformed odds ratio OR), no moderators are included, but one can simply include moderators as in section 1.5. 

### 2. Fisher-transformed Pearson's correlations (r)

`mc.fcor()` is the function to test the between-study heterogeneity in meta-analysis of Fisher-transformed Pearson's correlations (r). 

Load the example dataset `sensation` first: 

```{r}
sensation <- mc.heterogeneity:::sensation
```

Extract the required arguments from `sensation`:

```{r}
# n is a list of samples sizes
n <- sensation$n
# Pearson's correlation
r <- sensation$r
# Fisher's Transformation
z <- 1/2*log((1+r)/(1-r))
```

Run the heterogeneity test using `mc.fcor()`:

```{r, eval=FALSE}
mc.run <- mc.fcor(n, z, model = 'random', p_cut = 0.05)
```

### 3. Natural-logarithm-transformed odds ratio (OR)

`mc.lnOR()` is the function to test the between-study heterogeneity in meta-analysis of Natural-logarithm-transformed odds ratio (OR). 

Load the example dataset `smoking` from R package `HSAUR2`: 

```{r}
library(HSAUR2)
data(smoking)
```

Extract the required arguments from `smoking`:

```{r}
# Y1: receive treatment; Y2: stop smoking
n_00 <- smoking$tc - smoking$qc  # not receive treatement yet not stop smoking
n_01 <- smoking$qc # not receive treatement but stop smoking
n_10 <- smoking$tt - smoking$qt # receive treatement but not stop smoking
n_11 <- smoking$qt # receive treatement and stop smoking
```

The log odds ratios can be computed, but they are not needed by mc.lnOR():

```{r}
lnOR <- log(n_11*n_00/n_01/n_10)
lnOR
```

Run the heterogeneity test using `mc.lnOR()`:

```{r, eval=FALSE}
mc.run <- mc.lnOR(n_00, n_01, n_10, n_11, model = 'random', p_cut = 0.05)
```


